<!DOCTYPE html>
<html style="height: 100%;">
<head>
    <meta charset="utf-8" />
    <title>Chart</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }

        #tv_chart_container {
            width: 100%;
            height: 100%;
            background: #ffffff;
        }
    </style>

    <script src="charting_library/charting_library.standalone.js"></script>
</head>
<body>
    <div id="tv_chart_container"></div>

    <script>
        var _widget = null;

        const urlParams = new URLSearchParams(window.location.search);
        const displaySymbol = urlParams.get('symbol');

        window.onload = function() {
            if (typeof TradingView === 'undefined') {
                document.body.innerHTML = "<h2 style='color:red'>Library Not Found</h2>";
                return;
            }

            try {
                const Datafeed = {
                    onReady: (cb) => {
                        setTimeout(() => cb({
                            supported_resolutions: ['1', '5', '15', '30', '60', '1D'],
                            supports_marks: true,
                            supports_timescale_marks: true,
                            supports_time: true
                        }), 0)
                    },
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback) => {
                        setTimeout(() => {
                            onSymbolResolvedCallback({
                                name: symbolName,
                                description: symbolName,
                                type: 'MCX',
                                session: '24x7',
                                timezone: 'Asia/Kolkata',
                                exchange: 'thecalcify',
                                minmov: 1,
                                pricescale: 100,
                                has_intraday: true,
                                has_no_volume: true,
                                has_weekly_and_monthly: true,
                                supported_resolutions: ['1', '5', '15', '30', '60', '1D'],
                                data_status: 'streaming'
                            });
                        }, 0);
                    },
                    getBars: (symbolInfo, resolution, periodParams, onResult, onError) => {
                        // History API integration
                        console.log('[Datafeed] getBars called');
                        setTimeout(() => onResult([], { noData: true }), 0);
                    },
                    subscribeBars: (symbolInfo, resolution, onTick, listenerGuid) => {
                        window.currentSubscription = { onTick, listenerGuid };
                    },
                    unsubscribeBars: (listenerGuid) => {
                        window.currentSubscription = null;
                    }
                };

                _widget = new TradingView.widget({
                    symbol: displaySymbol,
                    interval: '1',
                    container: 'tv_chart_container',
                    datafeed: Datafeed,
                    library_path: 'charting_library/',
                    locale: 'en',
                    fullscreen: true,
                    autosize: true,
                    load_last_chart: true,
                    allow_symbol_change: false,
                    hideideas: true,
                    save_image: false,
                    theme: 'Light',
                    timezone: 'Asia/Kolkata',
                    debug: true,
                    displayedPriceScale: {
                        timeVisible: true,
                    },
                    disabled_features: [
                        'use_localstorage_for_settings',
                        'header_compare',
                        'header_settings',
                        'symbol_search_hot_key',
                        'header_saveload',
                        'show_exchange_logos',
                        'chart_template_storage',
                        'save_shortcut',
                        'header_symbol_search',
                        'symbol_info',
                        'timezone_menu',
                        'widget_logo',
                        'header_screenshot'
                    ]
                });

                _widget.onChartReady(function () {
                    try {
                        var iframe = document.querySelector('#tv_chart_container iframe');
                        if (iframe) {
                            var doc = iframe.contentDocument || iframe.contentWindow.document;
                            var style = doc.createElement('style');
                            style.innerHTML = `.tv-chart-container__left-badge-container { display: none !important; }
                                                .tv-logo { display: none !important; opacity: 0 !important; }
                                                .branding-logo { display: none !important; }
                                                a[href*="tradingview.com"] { display: none !important; pointer-events: none !important; }
                                                div[data-name="legend-more-action"] { display: none !important; }`;
                            doc.head.appendChild(style);
                        }
                    } catch (e) { console.log("Logo Error: " + e); }
                });

            } catch(e) {
                console.error(e);
            }
        };

        window.updateTick = function(tickJson) {
            try {
                var tick = JSON.parse(tickJson);
                if (window.currentSubscription && window.currentSubscription.onTick) {
                    var bar = {
                        time: tick.time,
                        close: tick.ask,
                        open: tick.ask,
                        high: tick.ask,
                        low: tick.ask,
                        volume: tick.volume || 0
                    };
                    window.currentSubscription.onTick(bar);
                }
            } catch(e) { console.error(e); }
        };
    </script>
</body>
</html>